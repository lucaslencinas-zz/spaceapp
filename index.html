<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>GOT a flight</title>

  <meta name="viewport" content="width=device-width, initial-scale=0.8">

  <link rel="stylesheet" href="codepen-steps/css/reset.css">
  <link rel="stylesheet" href="codepen-steps/css/style.css">
  <link rel="stylesheet" href="styleTimepicker.css">
  <link rel="icon" type="image/ico" href="favicon.ico">

  <script src="js/jquery.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/hammer.js/2.0.4/hammer.min.js"></script>
  <script  src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.10.2/moment.min.js" ></script>
</head>
<body>
  <!-- multistep form -->
  <form id="msform">
    <!-- progressbar -->
    <ul id="progressbar">
      <li class="active">Airports</li>
      <li>Date and time</li>
      <li>Results</li>
    </ul>
    <!-- fieldsets -->
    <fieldset>
      <h2 class="fs-title">Airports</h2>
      <h3 class="fs-subtitle">Enter flight information</h3>

      <select id="selectAeropuertoDesde" placeholder="Desde">
        <option name="null">Select ...</option>
        <option name="KATL">Atlanta</option>
        <option name="KORD">Chicago</option>
        <option name="KJFK">New York</option>
        <option name="KPHL">Philadelphia</option>
        <option name="KSFO">San Francisco</option>
      </select>
      <select id="selectAeropuertoHasta" placeholder="Hasta">
        <option name="null">Select ...</option>
        <option name="KATL">Atlanta</option>
        <option name="KORD">Chicago</option>
        <option name="KJFK">New York</option>
        <option name="KPHL">Philadelphia</option>
        <option name="KSFO">San Francisco</option>
      </select>
      <!--<input type="button" name="previous" class="previous action-button" value="Previous" />-->
      <input type="button" name="next" id="nextAeropuerto" class="next action-button" value="Next" />
    </fieldset>
    <fieldset>
      <h2 class="fs-title">Flight date and time</h2>
      <h3 class="fs-subtitle">Select the time of your flight</h3>
      <!-- Time Picker -->
    <div class="swipe" id="DP-date">
        <div class='swipe-wrap'>
        </div>
      </div>
    <div class="picker-container">
    </div>
    <!-- Fin Time Picker  -->

      <input type="button" name="previous" class="previous action-button" value="Previous" />
      <input type="button" name="next" id="search" class="next action-button" value="Predict" />
    </fieldset>
    <fieldset>
      <h2 class="fs-title">Prediction</h2>
      <h3 class="fs-subtitle">Your flight forecast is...</h3>

      <h4 id="titleDelay" class="fs-title">Probability of delay</h4><span class="fs-subtitle" id="probabilityOfDelay"></span><br>
      <h4  class="fs-title">Reasons</h4><span class="fs-subtitle" id="reasonsOfDelay"></span><br><br>
      <input type="button" name="insurance" id="insuranceBtn" class="insurance action-button" value="Buy insurance" />
      <input type="button" name="submit" id="newFligthBtn" class="submit action-button" value="New flight" />
    </fieldset>
  </form>

  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js'></script>
  <script src='http://cdnjs.cloudflare.com/ajax/libs/jquery-easing/1.3/jquery.easing.min.js'></script>
  <script src="codepen-steps/js/index.js"></script>
  <script src="indexTimepicker.js"></script>
  <script type="text/javascript">
    var probabilidad = ["UNLIKELY", "LOW", "MEDIUM", "HIGH", "VERY HIGH"];
    /*var apiurl = "http://private-e158e-clearfortakeoff.apiary-mock.com/probability"*/
    var apiurl = "http://prudi.mybluemix.net/api/v1/weathers/probability?";
    /*origin=KORD&destiny=KEWR&date=20160424&hour=2325*/
    var meses = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dic"];
    $(function() {
      $(".swipe-wrap > div").click(function(){
        $(".swipe-wrap > .active").toggleClass("active");
        $( this ).toggleClass( "active" );
      });

      /*$("#selectAeropuertoHasta option[name='KORD']").prop('selected', true);*/
      $("#insuranceBtn").css ("width", "110px");
      $("#insuranceBtn").css("background", "#f44336");
      $("#titleDelay").css ("margin-top", "30px");

      $("#nextAeropuerto").click(function(event){
        var error = false;
        if($("#selectAeropuertoDesde").find('option:selected').attr("name") === "null"){
          $("#selectAeropuertoDesde").css("border-color", "red");
          error = true;
        }
        if($("#selectAeropuertoHasta").find('option:selected').attr("name") === "null"){
          $("#selectAeropuertoHasta").css("border-color", "red");
          error = true;
        }
        if(error){
          event.stopPropagation();
        }


      });


      $("#search").click(function(){
        var hora = $(".kitkat-am-pm").text() == "PM" ? 12 + +$(".kitkat-hour").text() : $(".kitkat-hour").text();
        var fecha = formatearFecha($(".swipe-wrap > .active").text());
        var horaString = formatearHora($(".kitkat-minute").text(), hora);
        var aeroDesde = $("#selectAeropuertoDesde").find('option:selected').attr("name");
        var aeroHasta = $("#selectAeropuertoHasta").find('option:selected').attr("name");
        console.log("date: " + fecha);
        console.log("hour: " + horaString);
        console.log("origin:" + aeroDesde);
        console.log("destiny:" + aeroHasta);

        setTimeout(function(){
        $.ajax({
            crossDomain: true,
            type:"GET",
            contentType: "application/json; charset=utf-8",
            url: apiurl + "origin=" + aeroDesde + "&destiny=" + aeroHasta + "&date=" + fecha + "&hour=" + horaString,
            dataType: "json",
            success: function(data) {

              renderResponse(data);
            },
            error: function() { alert('Failed!'); },
        })} /*end ajax*/
        , 1500);
      });/*end search click*/
    });

    function formatearFecha(fechaForm){
      var mesString = fechaForm.substring(fechaForm.length -3, fechaForm.length);
      var diaString = fechaForm.substring(0, fechaForm.length -3);
      if (diaString < 10){
        diaString = "0" + diaString;
      }
      var mesNumero = meses.indexOf(mesString) + 1;
      if (mesNumero < 10){
        mesNumero = "0" + mesNumero;
      }
      return "2016" + mesNumero + diaString;
    }

    function formatearHora(minuteForm, horaForm){
      var horaString = "";
      var minutoString = "";
      minutoString = minuteForm;

      if (horaForm < 10){
        horaString = "0" + horaForm;
      }else {
        horaString = horaForm;
      }

      return horaString + minutoString;
    }

    function renderResponse(data){
      var lugar = "";
      $("#probabilityOfDelay").text(probabilidad[data.probability -1]);
      $("#probabilityOfDelay").addClass("probability" + data.probability);
      if(data.source == "origin"){
        lugar = $("#selectAeropuertoDesde").find('option:selected').text();
      }
      else {
        lugar = $("#selectAeropuertoHasta").find('option:selected').text();
      }
      /*<span class="fs-subtitle" id="delayedAirport"></span>*/
      $("#reasonsOfDelay").text(data.reasons + " in " + lugar);
    }

    $( "#selectAeropuertoDesde" ).change(function () {

    });
    /*http://localhost:3000/api/v1/weathers/probability?origin=KPHL&destiny=KOKC&date=20160424&hour=2400*/
    /*http://prudi.mybluemix.net/api/v1/weathers/probability?origin=KORD&destiny=KEWR&date=20160424&hour=2325*/

  </script>
</body>
</html>
